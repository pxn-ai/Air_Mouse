<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gyro Viewer Pro</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #22262f;
            --border: #2d3140;
            --text: #e8eaed;
            --text-dim: #8b8fa3;
            --accent: #6c5ce7;
            --accent-glow: rgba(108, 92, 231, 0.3);
            --roll-color: #00cec9;
            --pitch-color: #fdcb6e;
            --yaw-color: #e17055;
            --compass-color: #74b9ff;
            --compass-n: #ff6b6b;
            --ring-bg: #2d3140;
            --positive: #00b894;
            --negative: #d63031;
            --radius: 12px;
        }

        [data-theme="light"] {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --surface-2: #f8f9fa;
            --border: #dee2e6;
            --text: #212529;
            --text-dim: #6c757d;
            --ring-bg: #dee2e6;
            --accent-glow: rgba(108, 92, 231, 0.15);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.4s, color 0.4s;
        }

        /* â”€â”€â”€ Top Bar â”€â”€â”€ */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .top-bar h1 {
            font-size: 1.15rem;
            font-weight: 700;
            letter-spacing: -0.3px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .top-bar h1 span {
            color: var(--accent);
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--surface-2);
        }

        .transport-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            transition: all 0.3s;
        }

        .transport-badge.wifi {
            border-color: var(--positive);
            color: var(--positive);
        }

        .transport-badge.serial {
            border-color: var(--pitch-color);
            color: var(--pitch-color);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--negative);
            animation: pulse-dot 1.5s infinite;
        }

        .status-badge.connected .status-dot {
            background: var(--positive);
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .btn-reset {
            border-color: var(--negative);
            color: var(--negative);
        }

        .btn-reset:hover {
            background: rgba(214, 48, 49, 0.1);
            border-color: var(--negative);
        }

        .btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* â”€â”€â”€ Main Grid â”€â”€â”€ */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr auto;
            gap: 16px;
            padding: 20px 24px;
            height: calc(100vh - 65px);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: background 0.4s, border-color 0.4s;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .card-compass::before {
            background: var(--compass-color);
        }

        .card-roll::before {
            background: var(--roll-color);
        }

        .card-pitch::before {
            background: var(--pitch-color);
        }

        .card-yaw::before {
            background: var(--yaw-color);
        }

        .card-status::before {
            background: var(--accent);
        }

        /* Status card spans full width at bottom */
        .card-status {
            grid-column: 1 / -1;
        }

        .card-title {
            position: absolute;
            top: 16px;
            left: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-dim);
        }

        .card-value {
            position: absolute;
            top: 14px;
            right: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            font-weight: 500;
        }

        canvas {
            display: block;
        }

        /* â”€â”€â”€ Error Overlay â”€â”€â”€ */
        .error-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: var(--radius);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .error-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .error-overlay svg {
            width: 36px;
            height: 36px;
            fill: var(--negative);
            margin-bottom: 8px;
            animation: pulse-error 1.5s infinite;
        }

        .error-overlay .error-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--negative);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .error-overlay .error-detail {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 4px;
        }

        @keyframes pulse-error {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(0.92);
            }
        }

        /* â”€â”€â”€ Status Card Content â”€â”€â”€ */
        .status-devices {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 8px 0;
        }

        .device-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--surface-2);
            min-width: 220px;
            transition: border-color 0.3s, background 0.3s;
        }

        .device-item.error {
            border-color: var(--negative);
            background: rgba(214, 48, 49, 0.08);
        }

        .device-item.ok {
            border-color: var(--positive);
        }

        .device-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-dim);
            flex-shrink: 0;
            transition: background 0.3s, box-shadow 0.3s;
        }

        .device-item.ok .device-indicator {
            background: var(--positive);
            box-shadow: 0 0 8px rgba(0, 184, 148, 0.6);
        }

        .device-item.error .device-indicator {
            background: var(--negative);
            box-shadow: 0 0 8px rgba(214, 48, 49, 0.6);
            animation: pulse-dot 1s infinite;
        }

        .device-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .device-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
        }

        .device-detail {
            font-size: 0.68rem;
            color: var(--text-dim);
            font-family: 'JetBrains Mono', monospace;
        }

        .device-status-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: auto;
        }

        .device-item.ok .device-status-label {
            color: var(--positive);
        }

        .device-item.error .device-status-label {
            color: var(--negative);
        }

        /* â”€â”€â”€ Responsive â”€â”€â”€ */
        @media (max-width: 800px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(4, 1fr) auto;
            }

            .status-devices {
                flex-direction: column;
                gap: 10px;
            }

            .device-item {
                min-width: unset;
            }
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <h1>
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M12 2a15 15 0 0 1 0 20M12 2a15 15 0 0 0 0 20M2 12h20" />
            </svg>
            <span>GYRO</span> VIEWER PRO
        </h1>
        <div class="top-bar-actions">
            <div class="status-badge" id="status">
                <div class="status-dot"></div>
                <span>Disconnected</span>
            </div>
            <div class="transport-badge serial" id="transport-badge">
                <span id="transport-icon">ðŸ”Œ</span>
                <span id="transport-label">Serial</span>
            </div>
            <button class="btn btn-reset" onclick="resetOffset()" title="Reset orientation to zero">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M17.65 6.35A7.96 7.96 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg>
                Reset
            </button>
            <button class="btn" onclick="toggleTheme()" id="theme-btn" title="Toggle theme">
                <svg id="theme-icon" viewBox="0 0 24 24">
                    <path
                        d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.39 5.39 0 0 1-4.4 2.26 5.4 5.4 0 0 1-5.4-5.4c0-1.81.89-3.42 2.26-4.4A8.7 8.7 0 0 0 12 3z" />
                </svg>
                <span id="theme-label">Dark</span>
            </button>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
        <div class="card card-compass" id="card-compass">
            <div class="error-overlay" id="overlay-compass">
                <svg viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                </svg>
                <span class="error-label">Sensor Offline</span>
                <span class="error-detail" id="overlay-compass-detail">HMC5883L disconnected</span>
            </div>
            <span class="card-title">Compass / Heading</span>
            <span class="card-value" id="compass-val" style="color:var(--compass-color)">0Â°</span>
            <canvas id="compass-canvas"></canvas>
        </div>
        <div class="card card-roll" id="card-roll">
            <div class="error-overlay" id="overlay-roll">
                <svg viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                </svg>
                <span class="error-label">Sensor Offline</span>
                <span class="error-detail">MPU6500 disconnected</span>
            </div>
            <span class="card-title">Roll (X-Axis)</span>
            <span class="card-value" id="roll-val" style="color:var(--roll-color)">0Â°</span>
            <canvas id="roll-canvas"></canvas>
        </div>
        <div class="card card-pitch" id="card-pitch">
            <div class="error-overlay" id="overlay-pitch">
                <svg viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                </svg>
                <span class="error-label">Sensor Offline</span>
                <span class="error-detail">MPU6500 disconnected</span>
            </div>
            <span class="card-title">Pitch (Y-Axis)</span>
            <span class="card-value" id="pitch-val" style="color:var(--pitch-color)">0Â°</span>
            <canvas id="pitch-canvas"></canvas>
        </div>
        <div class="card card-yaw" id="card-yaw">
            <div class="error-overlay" id="overlay-yaw">
                <svg viewBox="0 0 24 24">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                </svg>
                <span class="error-label">Sensor Offline</span>
                <span class="error-detail" id="overlay-yaw-detail">IMU + MAG needed</span>
            </div>
            <span class="card-title">Yaw (Z-Axis)</span>
            <span class="card-value" id="yaw-val" style="color:var(--yaw-color)">0Â°</span>
            <canvas id="yaw-canvas"></canvas>
        </div>

        <!-- Signal Status Card -->
        <div class="card card-status">
            <span class="card-title">Signal Status</span>
            <div class="status-devices">
                <div class="device-item ok" id="device-imu">
                    <div class="device-indicator"></div>
                    <div class="device-info">
                        <span class="device-name">MPU6500 â€” IMU</span>
                        <span class="device-detail">IÂ²C 0x68 Â· Accel + Gyro</span>
                    </div>
                    <span class="device-status-label" id="imu-status-label">Online</span>
                </div>
                <div class="device-item ok" id="device-mag">
                    <div class="device-indicator"></div>
                    <div class="device-info">
                        <span class="device-name">HMC5883L â€” Magnetometer</span>
                        <span class="device-detail">IÂ²C 0x1E Â· Compass</span>
                    </div>
                    <span class="device-status-label" id="mag-status-label">Online</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let isDark = true;
        function toggleTheme() {
            isDark = !isDark;
            document.body.setAttribute('data-theme', isDark ? '' : 'light');
            if (!isDark) document.body.setAttribute('data-theme', 'light');
            else document.body.removeAttribute('data-theme');
            document.getElementById('theme-label').textContent = isDark ? 'Dark' : 'Light';
            document.getElementById('theme-icon').innerHTML = isDark
                ? '<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.39 5.39 0 0 1-4.4 2.26 5.4 5.4 0 0 1-5.4-5.4c0-1.81.89-3.42 2.26-4.4A8.7 8.7 0 0 0 12 3z"/>'
                : '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>';
        }

        // â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let rawRoll = 0, rawPitch = 0, rawYaw = 0;
        let offsetRoll = 0, offsetPitch = 0, offsetYaw = 0;
        let dispRoll = 0, dispPitch = 0, dispYaw = 0;
        // Smoothed (animated) values
        let animRoll = 0, animPitch = 0, animYaw = 0;

        function resetOffset() {
            offsetRoll = rawRoll;
            offsetPitch = rawPitch;
            offsetYaw = rawYaw;
        }

        // â”€â”€ SocketIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const socket = io();
        const statusEl = document.getElementById('status');

        socket.on('connect', () => {
            statusEl.classList.add('connected');
            statusEl.querySelector('span').textContent = 'Connected';
        });
        socket.on('disconnect', () => {
            statusEl.classList.remove('connected');
            statusEl.querySelector('span').textContent = 'Disconnected';
        });

        // â”€â”€ Transport Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        socket.on('transport_mode', (data) => {
            const badge = document.getElementById('transport-badge');
            const icon = document.getElementById('transport-icon');
            const label = document.getElementById('transport-label');
            if (data.mode === 'wifi') {
                badge.className = 'transport-badge wifi';
                icon.textContent = 'ðŸ“¡';
                label.textContent = 'WiFi';
            } else {
                badge.className = 'transport-badge serial';
                icon.textContent = 'ðŸ”Œ';
                label.textContent = 'Serial';
            }
        });

        // â”€â”€ Device Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let imuOk = true, magOk = true;

        socket.on('device_status', (data) => {
            imuOk = data.imu;
            magOk = data.mag;

            // Update IMU device card
            const imuEl = document.getElementById('device-imu');
            imuEl.className = 'device-item ' + (imuOk ? 'ok' : 'error');
            document.getElementById('imu-status-label').textContent = imuOk ? 'Online' : 'Offline';

            // Update MAG device card
            const magEl = document.getElementById('device-mag');
            magEl.className = 'device-item ' + (magOk ? 'ok' : 'error');
            document.getElementById('mag-status-label').textContent = magOk ? 'Online' : 'Offline';

            // Roll & Pitch depend on IMU
            document.getElementById('overlay-roll').classList.toggle('active', !imuOk);
            document.getElementById('overlay-pitch').classList.toggle('active', !imuOk);

            // Compass depends on MAG (primarily)
            document.getElementById('overlay-compass').classList.toggle('active', !magOk);

            // Yaw depends on both IMU and MAG
            const yawBad = !imuOk || !magOk;
            const yawOverlay = document.getElementById('overlay-yaw');
            yawOverlay.classList.toggle('active', yawBad);
            if (yawBad) {
                document.getElementById('overlay-yaw-detail').textContent =
                    !imuOk && !magOk ? 'IMU + MAG disconnected'
                        : !imuOk ? 'MPU6500 disconnected'
                            : 'HMC5883L disconnected';
            }
        });

        socket.on('euler_data', (data) => {
            rawRoll = data.roll;
            rawPitch = data.pitch;
            rawYaw = data.yaw;

            dispRoll = rawRoll - offsetRoll;
            dispPitch = rawPitch - offsetPitch;
            dispYaw = rawYaw - offsetYaw;
        });

        // â”€â”€ Canvas Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const dpr = window.devicePixelRatio || 1;

        function setupCanvas(id) {
            const canvas = document.getElementById(id);
            const rect = canvas.parentElement.getBoundingClientRect();
            const size = Math.min(rect.width - 40, rect.height - 60);
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
            return { ctx, size };
        }

        // â”€â”€ Compass Dial â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function drawCompass(ctx, size, heading) {
            const cx = size / 2, cy = size / 2;
            const r = size / 2 - 16;
            ctx.clearRect(0, 0, size, size);

            const style = getComputedStyle(document.body);
            const textColor = style.getPropertyValue('--text').trim();
            const dimColor = style.getPropertyValue('--text-dim').trim();
            const ringBg = style.getPropertyValue('--ring-bg').trim();

            // Outer ring
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.strokeStyle = ringBg;
            ctx.lineWidth = 10;
            ctx.stroke();

            // Tick marks
            for (let i = 0; i < 360; i += 10) {
                const rad = (i - 90) * Math.PI / 180;
                const isMajor = i % 30 === 0;
                const inner = r - (isMajor ? 18 : 10);
                const outer = r - 2;
                ctx.beginPath();
                ctx.moveTo(cx + inner * Math.cos(rad), cy + inner * Math.sin(rad));
                ctx.lineTo(cx + outer * Math.cos(rad), cy + outer * Math.sin(rad));
                ctx.strokeStyle = isMajor ? textColor : dimColor;
                ctx.lineWidth = isMajor ? 2 : 1;
                ctx.stroke();
            }

            // Cardinal labels
            const labels = { 0: 'N', 90: 'E', 180: 'S', 270: 'W' };
            ctx.font = '600 14px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for (const [deg, label] of Object.entries(labels)) {
                const rad = (parseInt(deg) - 90) * Math.PI / 180;
                const lr = r - 32;
                ctx.fillStyle = label === 'N' ? '#ff6b6b' : textColor;
                ctx.fillText(label, cx + lr * Math.cos(rad), cy + lr * Math.sin(rad));
            }

            // Needle
            const needleAngle = (heading - 90) * Math.PI / 180;
            const needleLen = r - 42;

            // North (red) pointer
            ctx.beginPath();
            ctx.moveTo(cx + needleLen * Math.cos(needleAngle), cy + needleLen * Math.sin(needleAngle));
            const perpAngle = needleAngle + Math.PI / 2;
            ctx.lineTo(cx + 6 * Math.cos(perpAngle), cy + 6 * Math.sin(perpAngle));
            ctx.lineTo(cx - 6 * Math.cos(perpAngle), cy - 6 * Math.sin(perpAngle));
            ctx.closePath();
            ctx.fillStyle = '#ff6b6b';
            ctx.fill();

            // South (dim) pointer
            ctx.beginPath();
            ctx.moveTo(cx - needleLen * Math.cos(needleAngle), cy - needleLen * Math.sin(needleAngle));
            ctx.lineTo(cx + 5 * Math.cos(perpAngle), cy + 5 * Math.sin(perpAngle));
            ctx.lineTo(cx - 5 * Math.cos(perpAngle), cy - 5 * Math.sin(perpAngle));
            ctx.closePath();
            ctx.fillStyle = dimColor;
            ctx.fill();

            // Center dot
            ctx.beginPath();
            ctx.arc(cx, cy, 5, 0, Math.PI * 2);
            ctx.fillStyle = textColor;
            ctx.fill();
        }

        // â”€â”€ Attitude Gauge (for Roll / Pitch / Yaw) â”€â”€â”€â”€â”€
        function drawAttitudeGauge(ctx, size, angle, color, label, maxRange) {
            const cx = size / 2, cy = size / 2;
            const r = size / 2 - 16;
            ctx.clearRect(0, 0, size, size);

            const style = getComputedStyle(document.body);
            const textColor = style.getPropertyValue('--text').trim();
            const dimColor = style.getPropertyValue('--text-dim').trim();
            const ringBg = style.getPropertyValue('--ring-bg').trim();

            // Background ring
            ctx.beginPath();
            ctx.arc(cx, cy, r, 0, Math.PI * 2);
            ctx.strokeStyle = ringBg;
            ctx.lineWidth = 10;
            ctx.stroke();

            // Angle arc (proportion of full range)
            const clampedAngle = Math.max(-maxRange, Math.min(maxRange, angle));
            const fraction = clampedAngle / maxRange; // -1 to 1
            const arcStart = -Math.PI / 2; // top
            const arcEnd = arcStart + fraction * Math.PI;

            ctx.beginPath();
            if (fraction >= 0) {
                ctx.arc(cx, cy, r, arcStart, arcEnd);
            } else {
                ctx.arc(cx, cy, r, arcEnd, arcStart);
            }
            ctx.strokeStyle = color;
            ctx.lineWidth = 10;
            ctx.lineCap = 'round';
            ctx.stroke();
            ctx.lineCap = 'butt';

            // Tick marks around the outside
            const numTicks = 12;
            for (let i = 0; i <= numTicks; i++) {
                const tickAngle = -Math.PI + (i / numTicks) * Math.PI * 2;
                const inner = r - 14;
                const outer = r - 4;
                ctx.beginPath();
                ctx.moveTo(cx + inner * Math.cos(tickAngle), cy + inner * Math.sin(tickAngle));
                ctx.lineTo(cx + outer * Math.cos(tickAngle), cy + outer * Math.sin(tickAngle));
                ctx.strokeStyle = (i === 0 || i === numTicks / 2 || i === numTicks) ? textColor : dimColor;
                ctx.lineWidth = (i === 0 || i === numTicks / 2 || i === numTicks) ? 2 : 1;
                ctx.stroke();
            }

            // Pointer needle
            const needleAngle = arcStart + fraction * Math.PI;
            const needleLen = r - 26;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(cx + needleLen * Math.cos(needleAngle), cy + needleLen * Math.sin(needleAngle));
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.stroke();
            ctx.lineCap = 'butt';

            // Needle tip dot
            ctx.beginPath();
            ctx.arc(cx + needleLen * Math.cos(needleAngle), cy + needleLen * Math.sin(needleAngle), 5, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();

            // Center label
            ctx.font = '700 28px "JetBrains Mono", monospace';
            ctx.fillStyle = textColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(angle.toFixed(1) + 'Â°', cx, cy - 6);

            ctx.font = '500 12px Inter, sans-serif';
            ctx.fillStyle = dimColor;
            ctx.fillText(label, cx, cy + 18);

            // Center dot
            ctx.beginPath();
            ctx.arc(cx, cy, 4, 0, Math.PI * 2);
            ctx.fillStyle = textColor;
            ctx.fill();
        }

        // â”€â”€ Animation Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const lerp = (a, b, t) => a + (b - a) * t;

        function lerpAngle(a, b, t) {
            let diff = b - a;
            while (diff > 180) diff -= 360;
            while (diff < -180) diff += 360;
            return a + diff * t;
        }

        function animate() {
            requestAnimationFrame(animate);

            // Smooth interpolation
            animRoll = lerp(animRoll, dispRoll, 0.12);
            animPitch = lerp(animPitch, dispPitch, 0.12);
            animYaw = lerpAngle(animYaw, dispYaw, 0.12);

            const heading = ((animYaw % 360) + 360) % 360;

            // Draw all 4 canvases
            const compass = setupCanvas('compass-canvas');
            drawCompass(compass.ctx, compass.size, heading);
            document.getElementById('compass-val').textContent = heading.toFixed(0) + 'Â°';

            const roll = setupCanvas('roll-canvas');
            drawAttitudeGauge(roll.ctx, roll.size, animRoll, '#00cec9', 'ROLL', 180);
            document.getElementById('roll-val').textContent = animRoll.toFixed(1) + 'Â°';

            const pitch = setupCanvas('pitch-canvas');
            drawAttitudeGauge(pitch.ctx, pitch.size, animPitch, '#fdcb6e', 'PITCH', 90);
            document.getElementById('pitch-val').textContent = animPitch.toFixed(1) + 'Â°';

            const yaw = setupCanvas('yaw-canvas');
            drawAttitudeGauge(yaw.ctx, yaw.size, animYaw, '#e17055', 'YAW', 180);
            document.getElementById('yaw-val').textContent = animYaw.toFixed(1) + 'Â°';
        }

        animate();
    </script>
</body>

</html>